/* Energy Switch Gaurantee - Refunds */
select
  ta.account_id as account_id,
  at2.creationdetail_createddate as transaction_date,
  at2.transactiontype as transaction_type,
  at2.transactiontypefriendlyname description,
  case when su.external_id is null then 'N' else 'Y' end account_id_found,
  case when at2.account_id is null then 'N' else 'Y' end last_transaction_with_refund_found
--   ac.status
from temp_account_id ta
     left outer join ref_cdb_supply_contracts su on su.external_id = ta.account_id
-- inner join ref_account_status ac on ac.account_id = su.external_id
left outer join (select at.* from aws_s3_stage2_extracts.stage2_accounttransactions at
                  inner join (select a.account_id,  max(creationdetail_createddate) created_date
                              from aws_s3_stage2_extracts.stage2_accounttransactions a
                              group by a.account_id) at1
                  on at.account_id = at1.account_id and at.creationdetail_createddate = at1.created_date
                where at.transactiontype = 'R') at2
         on at2.account_id = ta.account_id

order by ta.account_id;




-- delete from temp_account_id;
-- Insert the accounts into temp table
insert into temp_account_id values
(1891),
(2029),
(2109),
(2334),
(2364),
(2382),
(2390),
(2465),
(2513),
(2660),
(2782),
(2813),
(2829),
(2960),
(2995),
(3000),
(3016),
(3204),
(3276),
(3307),
(3463),
(3471),
(4061),
(4300),
(4325),
(4408),
(4753),
(4764),
(4883),
(4941),
(4986),
(5147),
(5392),
(5536),
(5621),
(5645),
(5712),
(5789),
(5803),
(5879),
(5926),
(6176),
(6257),
(6278),
(6312),
(6401),
(6432),
(6595),
(6816),
(6872),
(6963),
(6964),
(6985),
(6988),
(7015),
(7027),
(7042),
(7098),
(7146),
(7204),
(7230),
(7273),
(7480),
(7509),
(7592),
(7883),
(8231),
(8564),
(9709),
(10852),
(10992),
(11222),
(11276),
(11302),
(11347),
(11569),
(11684),
(11868),
(12356),
(12388),
(12468),
(12598),
(12707),
(13061),
(13066),
(13076),
(13136),
(13202),
(13304),
(13414),
(13474),
(13538),
(13646),
(13891),
(13955),
(13978),
(14017),
(14276),
(14589),
(14595),
(14704),
(14724),
(14877),
(14928),
(14937),
(15120),
(15150),
(15153),
(15193),
(15264),
(15329),
(15371),
(15480),
(15590),
(15753),
(15827),
(15924),
(16015),
(16420),
(16522),
(16584),
(16736),
(16881),
(16886),
(17606),
(18361),
(18448),
(18536),
(18558),
(18628),
(18736),
(18832),
(18836),
(19226),
(19295),
(19878),
(20172),
(20179),
(20181),
(20203),
(20312),
(20326),
(20434),
(21246),
(21391),
(21568),
(21593),
(21670),
(21731),
(21769),
(21848),
(21889),
(21935),
(21990),
(22208),
(22501),
(22575),
(22615),
(22734),
(22831),
(22887),
(22961),
(22985),
(23127),
(23399),
(23428),
(23459),
(23664),
(23721),
(23749),
(24014),
(24017),
(24158),
(24208),
(24535),
(24544),
(24552),
(24555),
(24687),
(24710),
(24760),
(24778),
(24939),
(24957),
(25117),
(25426),
(25470),
(25867),
(26159),
(26212),
(26353),
(26358),
(26424),
(26612),
(26717),
(26769),
(26788),
(27101),
(27104),
(27120),
(27146),
(27183),
(27334),
(27456),
(27489),
(28374),
(28402),
(28439),
(28492),
(28881),
(29271),
(30008),
(30027),
(30109),
(30205),
(30613),
(31045),
(31200),
(32192),
(32555),
(32651),
(32818),
(32849),
(32872),
(32935),
(33117),
(33134),
(33483),
(33511),
(33650),
(33692),
(33773),
(34044),
(34489),
(34816),
(35189),
(35962),
(36863),
(37035),
(37043),
(37098),
(37402),
(37407),
(37456),
(37695),
(37775),
(38046),
(38080),
(38146),
(38170),
(38193),
(38216),
(38217),
(38232),
(38335),
(38344),
(38373),
(38380),
(38427),
(38430),
(38434),
(38504),
(38594),
(38610),
(38768),
(38794),
(38870),
(38885),
(39094),
(39117),
(39296),
(40381),
(40922),
(41012),
(41319),
(42273),
(42525),
(43043),
(43542),
(43687)