select su.external_id                       as account_id,
       rcup.user_id                         as igloo_user_id,
       rca.postcode                         as supply_postcode,
       ac.status                            as account_status,
       mp_elec.meterpointtype               as meterpoint_type_elec,
       mp_gas.meterpointtype                as meterpoint_type_gas,
       case
         when (mp_elec.meterpointtype is not null and mp_gas.meterpointtype is not null)
                 then 'dual_fuel'
         else 'single_fuel' end             as dual,
       case
         when (mp_elec.supplyenddate is null or mp_elec.supplyenddate >= current_date) then 'Live'
         else 'Not Live' end                as meterpoints_status_elec,
       case
         when (
           mp_gas.meterpointtype = 'G' and (mp_gas.supplyenddate is null or mp_gas.supplyenddate >= current_date))
                 then 'Live'
         else 'Not Live' end                as meterpoints_status_gas,
       rse.status                           as registration_status_elec,
       rsg.status                           as registration_status_gas,
       mp_elec.supplystartdate              as supply_startdate_elec,
       mp_elec.supplyenddate                as supply_enddate_elec,
       mp_gas.supplystartdate               as supply_startdate_gas,
       mp_gas.supplyenddate                 as supply_enddate_gas,
       su.created_at                        as supply_contract_creation_date,
       mp_elec.meter_point_id               as meter_point_id_elec,
       mp_gas.meter_point_id                as meter_point_id_gas,
       mt_elec.meter_id                     as meter_id_elec,
       mt_gas.meter_id                      as meter_id_gas,
       reg_elec.register_id                 as register_id_elec,
       reg_gas.register_id                  as register_id_gas,
       reg_elec.registers_eacaq             as register_elec_eacaq,
       reg_gas.registers_eacaq              as register_gas_eacaq,
       reg_elec.registers_registerreference as register_elec_reference,
       reg_gas.registers_registerreference  as register_gas_reference,
       reg_elec.registers_tpr               as register_elec_tpr,
       reg_gas.registers_tpr                as register_gas_tpr
from ref_cdb_supply_contracts su --inner join temp_cab_dates_quarter4_2018 we on we.external_id = su.external_id
       inner join ref_cdb_user_permissions rcup on su.id = rcup.permissionable_id and permission_level = 0 and
                                                   permissionable_type = 'App\\SupplyContract'
       inner join ref_cdb_users rcu on rcup.user_id = rcu.id
       inner join ref_cdb_addresses rca on su.supply_address_id = rca.id
       left outer join ref_account_status ac on ac.account_id = su.external_id
       left outer join ref_meterpoints mp_elec on mp_elec.account_id = su.external_id and mp_elec.meterpointtype = 'E'
       left outer join ref_meterpoints_attributes mpa_elec on mp_elec.meter_point_id = mpa_elec.meter_point_id and
                                                              attributes_effectivetodate is null
       left outer join ref_meters mt_elec
         on mp_elec.meter_point_id = mt_elec.meter_point_id and mt_elec.removeddate is null
       left outer join ref_meters_attributes mta_elec on mt_elec.meter_id = mta_elec.meter_id
       left outer join ref_registers reg_elec on mt_elec.meter_id = reg_elec.meter_id
       left outer join ref_registers_attributes rga_elec on reg_elec.register_id = rga_elec.register_id
       left outer join ref_meterpoints mp_gas on mp_gas.account_id = su.external_id and mp_gas.meterpointtype = 'G'
       left outer join ref_meters mt_gas on mp_gas.meter_point_id = mt_gas.meter_point_id and mt_gas.removeddate is null
       left outer join ref_registers reg_gas on mt_gas.meter_id = reg_gas.meter_id
       left outer join ref_registers_attributes rga_gas on reg_gas.register_id = rga_gas.register_id
       left outer join ref_registrations_status_gas rsg on mp_elec.account_id = rsg.account_id
       left outer join ref_registrations_status_elec rse on mp_elec.account_id = rse.account_id
where su.external_id in (
16196,
23565,
2747,
15605,
3833,
36102,
16517,
34430,
38241,
23201,
15056,
16050,
6249,
21431,
22725,
2023,
5790,
16207,
18883,
11066,
35560,
27320,
22352,
22195,
27462,
15010,
37757,
31052,
6473,
30477,
15429,
33379,
26933,
38119,
6990,
5931,
38161,
19068,
37168,
31049,
30783,
10857,
28225,
4661,
34916,
30195,
34870,
37106,
29728,
26413,
10846,
27272,
38182,
11463,
20446,
36284,
7840,
38124,
5142,
36669,
13921,
37464,
2289,
30221,
32470,
37380,
27146,
13728,
6285,
2297,
33681,
18582,
20906,
20411,
5325,
15811,
37755,
35295,
24346,
3676,
34920,
12733,
26017,
34402,
31521,
28830,
14569,
34430,
33786,
37485,
29728,
13179,
33111,
3759,
26667,
4434,
33561,
6874,
20442,
33189,
17756,
25042,
37447,
28690,
6835,
6862,
13669,
33306,
37151,
23102,
33434,
36581,
7814,
37064,
36560,
6539,
32880,
20892,
2923,
5861,
37106,
6785,
36947,
19413,
18430,
32925,
33111,
2952,
26325,
12865,
37082,
3826,
37075,
37092,
32806,
37167,
35720,
11104,
23767,
16671,
26123,
26123,
21177,
35935,
6322,
19843,
6676,
26068,
37015,
17375,
34232,
33278,
11859,
12223,
22788,
36569,
31227,
32233,
20346,
19997,
32920,
36054,
7399,
26107,
37553,
17891,
34505,
32097,
25416,
28378,
29801,
5089,
28849,
31979,
32074,
5072,
36597,
15753,
35327,
32643,
35669,
31615,
11098,
5893,
16525,
23569,
16504,
23565,
4217,
31951,
35519,
28677,
36308,
5845,
36199,
11688,
29871,
36121,
16138,
35944,
21954,
23132,
25940,
35884,
35838,
35887,
35803,
31298,
32780,
4106,
37734,
35784,
37774,
2829,
36762,
22339,
35113,
37344,
35720,
34724,
28903,
20729,
35388,
37307,
12779,
11081,
8528,
35373,
35655,
22352,
37090,
5579,
15953,
24520,
35420,
0,
22276,
28544,
21750,
25380,
5691,
25320,
27856,
2923,
8279,
9758,
34283,
28003,
30735,
27558,
30631,
30631,
35001,
35114,
33796,
11154,
7684,
35249,
17024,
15801,
34621,
18820,
32166,
37007,
16050,
34347,
37081,
21673,
35567,
29163,
36995,
30577,
34417,
35092,
5341,
25355,
35124,
5722,
27988,
30234,
30221,
15395,
18421,
32227,
4663,
6461,
29529,
20879,
4243,
35928,
25103,
15998,
7350,
34546,
9815,
30548,
30396,
27253,
29890,
28628,
25025,
30587,
24831,
27581,
6758,
24996,
24057,
14307,
3789,
28156,
32920,
26638,
37521,
34320,
34323,
33402,
15342,
31110,
2759,
20928,
23022,
34243,
29528,
18304,
36491,
6473,
34045,
35019,
34087,
23359,
29307,
11917,
33319,
25200,
33399,
26957,
35803,
0,
33306,
13979,
29893,
19172,
35975,
30937,
4485,
20272,
31968,
2076,
13728,
26805,
29070,
21202,
20320,
3522,
33277,
20224,
4661,
5521,
28788,
5085,
11647,
34283,
30568,
16729,
19546,
36890,
30843,
33188,
33188,
13289,
13158,
26621,
31190,
31638,
15478,
32925,
20320,
32268,
28865,
8270,
3675,
29063,
31305,
17583,
35465,
32922,
6653,
29184,
32880,
32982,
28535,
24159,
34927,
30477,
12732,
31121,
34502,
32576,
24596,
32668,
36406,
18346,
6164,
31473,
28127,
31934,
24100,
32440,
12342,
32044,
25416,
31586,
24114,
12099,
32728,
21929,
32806,
26024,
31927,
31354,
34722,
31932,
4252,
31771,
18054,
35377,
24000,
34876,
30954,
32233,
35372,
25526,
33970,
34388,
31360,
26104,
25173,
13805,
31698,
32077,
24464,
27868,
10844,
34413,
31596,
29796,
16020,
24979,
26589,
26070,
17452,
5845,
34327,
16772,
19857,
26101,
17650,
31350,
34385,
7296,
33529,
34396,
27975,
31906,
25302,
31862,
31968,
4123,
7976,
16687,
19323,
3145,
28832,
18935,
26111,
30577,
27729,
27935,
33993,
30532,
30933,
33620,
33561,
27728,
16279,
19014,
30807,
11492,
33350,
15201,
25021,
4021,
25541,
22163,
33055,
16235,
16207,
4597,
25434,
5745,
26080,
5761,
30195,
27416,
6050,
32687,
30993,
4609,
4092,
16128,
4578,
33076,
4243,
21393,
16050,
15628,
21480,
30641,
26416,
30577,
32745,
25200,
7112,
15277,
27298,
26494,
27566,
12091,
23492,
32398,
32327,
6338,
21064,
29039,
12877,
30093,
32836,
30701,
6915,
24698,
3419,
27166,
8448,
36851,
24831,
14248,
29125,
31795,
28638,
31968,
4532,
4132,
31823,
28884,
9643,
26135,
29728,
29357,
0,
31519,
29227,
28225,
0,
20556,
29046,
31354,
24684,
31405,
3475,
12314,
30938,
27646,
31364,
28927,
31358,
9642,
12282,
27779,
20224,
20320,
13560,
28865,
33218,
0,
31165,
24610,
28335,
11802,
12282,
28850,
30933,
29383,
30997,
20594,
12342,
30355,
26023,
19760,
30918,
0,
18177,
28542,
12535,
25290,
31360,
25307,
25012,
19504,
4393,
11969,
26723,
5791,
28058,
15242,
12252,
14623,
12455,
29561,
22737,
26141,
4457,
19236,
26101,
27016,
19892,
30415,
30734,
31314,
28098,
30234,
30231,
22779,
5109,
7471,
25958,
11235,
16252,
12049,
19338,
20255,
15335,
27550,
16318,
29999,
29893,
18270,
24174,
27412,
20346,
22823,
11750,
24897,
30182,
30012,
29912,
26261,
21144,
5881,
29692,
27051,
2073,
28797,
5443,
29387,
4184,
27838,
27810,
25653,
17811,
29102,
29057,
0,
16943,
23201,
29127,
23312,
16965,
27472,
28788,
27578,
6182,
24323,
20879,
22352,
27560,
6510,
2705,
0,
25343,
24617,
18766,
9778,
13477,
2946,
25200,
13568,
6477,
14441,
5854,
25170,
22978,
19740,
15128,
22664,
27097,
3229,
2121,
25148,
14602,
22278,
23589,
19786,
23934,
25958,
19760,
6929,
27016,
27016,
2946,
14478,
14424,
25002,
27112,
10985,
2525,
26993,
7965,
27022,
20519,
3270,
26721,
20575,
27965,
20455,
2810,
18360,
25670,
14157,
27810,
20319,
17291,
11560,
13408,
13580,
27472,
16833,
14880,
22872,
25657,
26621,
8515,
3552,
7348,
12842,
7840,
15718,
4143,
27746,
12493,
12759,
2959,
26147,
6137,
25802,
17891,
24062,
12562,
7684,
25290,
27432,
2107,
19488,
5912,
12892,
21214,
11269,
5845,
12015,
23474,
19221,
13477,
25173,
24068,
2549,
10865,
11999,
26101,
17979,
17032,
25307,
2526,
24669,
3348,
35377,
25434,
8424,
23727,
27058,
26929,
21958,
19217,
17176,
12584,
10899,
16699,
13477,
24700,
27028,
18655,
23116,
25201,
17652,
22342,
13568,
2766,
7979,
25647,
4963,
28566,
4120,
6622,
5899,
23215,
21152,
23916,
25623,
15982,
21561,
22991,
23102,
26878,
16239,
17979,
22886,
7285,
22932,
8199,
3631,
20445,
4140,
19236,
18311,
5925,
6473,
18696)
group by su.external_id,
         rcup.user_id,
         rca.postcode,
         ac.status,
         mp_elec.meterpointtype,
         mp_gas.meterpointtype,
         case
           when (mp_elec.meterpointtype is not null and mp_gas.meterpointtype is not null)
                   then 'dual_fuel'
           else 'single_fuel' end,
         case
           when (mp_elec.meterpointtype = 'E' and (mp_elec.supplyenddate is null or
                                                   (mp_elec.supplyenddate >= current_date and
                                                    mp_elec.supplyenddate >= mp_elec.supplystartdate))) then 'Live'
           else 'Not Live' end,
         case
           when (mp_gas.meterpointtype = 'G' and (mp_gas.supplyenddate is null or
                                                  (mp_gas.supplyenddate >= current_date and
                                                   mp_gas.supplyenddate >= mp_gas.supplystartdate))) then 'Live'
           else 'Not Live' end,
         rse.status,
         rsg.status,
         mp_elec.supplystartdate,
         mp_elec.supplyenddate,
         mp_gas.supplystartdate,
         mp_gas.supplyenddate,
         su.created_at,
         mp_elec.meter_point_id,
         mp_gas.meter_point_id,
         mt_elec.meter_id,
         mt_gas.meter_id,
         reg_elec.register_id,
         reg_gas.register_id,
         reg_elec.registers_eacaq,
         reg_gas.registers_eacaq,
         reg_elec.registers_registerreference,
         reg_gas.registers_registerreference,
         reg_elec.registers_tpr,
         reg_gas.registers_tpr
    --MeterPoints Attributes Elec
order by su.external_id
