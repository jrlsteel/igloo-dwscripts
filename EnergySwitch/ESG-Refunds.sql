/* Energy Switch Gaurantee - Refunds */
select
  ta.account_id as account_id,
  at2.creationdetail_createddate as transaction_date,
  at2.transactiontype as transaction_type,
  at2.transactiontypefriendlyname description,
  case when su.external_id is null then 'N' else 'Y' end account_id_found,
  case when at2.account_id is null then 'N' else 'Y' end last_transaction_with_refund_found
--   ac.status
from temp_account_id ta -- Insert the account_ids into this table and run this query
     left outer join ref_cdb_supply_contracts su on su.external_id = ta.account_id
     -- inner join ref_account_status ac on ac.account_id = su.external_id
     left outer join (select at.* from aws_s3_stage2_extracts.stage2_accounttransactions at
                        inner join (select cast(a.account_id as bigint),  max(cast(creationdetail_createddate as timestamp)) created_date
                                    from aws_s3_stage2_extracts.stage2_accounttransactions a
                                    group by a.account_id) at1
                        on cast(at.account_id as bigint) = at1.account_id and cast(at.creationdetail_createddate as timestamp) = at1.created_date
                      where at.transactiontype = 'R') at2
               on cast(at2.account_id as bigint) = ta.account_id

order by ta.account_id;

-- Temp table used to store account_ids to run the refunds sql.
delete from temp_account_id;


insert into temp_account_id values
(1891),
(1923),
(1976),
(2029),
(2061),
(2071),
(2109),
(2111),
(2226),
(2314),
(2316),
(2334),
(2364),
(2371),
(2382),
(2390),
(2460),
(2465),
(2487),
(2501),
(2513),
(2536),
(2623),
(2660),
(2716),
(2721),
(2732),
(2782),
(2800),
(2813),
(2824),
(2829),
(2839),
(2889),
(2900),
(2953),
(2960),
(2995),
(3000),
(3016),
(3160),
(3174),
(3185),
(3204),
(3274),
(3276),
(3280),
(3307),
(3315),
(3321),
(3376),
(3463),
(3471),
(3520),
(3594),
(3678),
(3806),
(3941),
(3986),
(4061),
(4239),
(4300),
(4325),
(4361),
(4408),
(4579),
(4726),
(4746),
(4753),
(4758),
(4764),
(4783),
(4881),
(4883),
(4884),
(4890),
(4941),
(4942),
(4986),
(5002),
(5075),
(5100),
(5113),
(5119),
(5123),
(5147),
(5388),
(5392),
(5412),
(5485),
(5536),
(5590),
(5621),
(5639),
(5645),
(5668),
(5712),
(5775),
(5789),
(5803),
(5828),
(5879),
(5926),
(5988),
(6012),
(6017),
(6176),
(6186),
(6204),
(6257),
(6278),
(6287),
(6312),
(6401),
(6432),
(6497),
(6502),
(6556),
(6595),
(6632),
(6718),
(6754),
(6763),
(6810),
(6816),
(6849),
(6871),
(6872),
(6899),
(6923),
(6963),
(6964),
(6985),
(6988),
(7015),
(7027),
(7028),
(7042),
(7098),
(7106),
(7115),
(7141),
(7146),
(7163),
(7171),
(7204),
(7230),
(7273),
(7341),
(7379),
(7381),
(7451),
(7480),
(7509),
(7592),
(7594),
(7609),
(7683),
(7708),
(7709),
(7711),
(7723),
(7814),
(7837),
(7865),
(7877),
(7883),
(7938),
(7957),
(7970),
(8067),
(8156),
(8215),
(8231),
(8323),
(8355),
(8427),
(8460),
(8465),
(8479),
(8506),
(8513),
(8564),
(9639),
(9702),
(9709),
(10852),
(10902),
(10929),
(10988),
(10992),
(11103),
(11222),
(11276),
(11278),
(11302),
(11337),
(11347),
(11352),
(11397),
(11517),
(11569),
(11638),
(11684),
(11687),
(11757),
(11770),
(11802),
(11868),
(11877),
(11912),
(11949),
(11992),
(11993),
(12042),
(12075),
(12204),
(12221),
(12253),
(12277),
(12342),
(12356),
(12388),
(12447),
(12468),
(12553),
(12564),
(12598),
(12610),
(12650),
(12676),
(12701),
(12707),
(12774),
(12834),
(12933),
(12976),
(13061),
(13062),
(13066),
(13071),
(13073),
(13076),
(13105),
(13134),
(13136),
(13202),
(13210),
(13292),
(13304),
(13307),
(13365),
(13370),
(13414),
(13474),
(13514),
(13538),
(13549),
(13596),
(13600),
(13610),
(13612),
(13623),
(13646),
(13749),
(13822),
(13838),
(13891),
(13915),
(13929),
(13955),
(13978),
(14017),
(14227),
(14276),
(14401),
(14440),
(14514),
(14589),
(14595),
(14620),
(14623),
(14704),
(14724),
(14791),
(14817),
(14829),
(14877),
(14928),
(14937),
(14940),
(14962),
(15003),
(15019),
(15024),
(15120),
(15150),
(15153),
(15193),
(15197),
(15264),
(15286),
(15329),
(15371),
(15373),
(15374),
(15386),
(15419),
(15480),
(15497),
(15518),
(15590),
(15753),
(15813),
(15816),
(15822),
(15827),
(15872),
(15924),
(15989),
(16015),
(16052),
(16140),
(16193),
(16358),
(16420),
(16468),
(16522),
(16528),
(16535),
(16584),
(16663),
(16689),
(16708),
(16725),
(16736),
(16784),
(16864),
(16872),
(16881),
(16886),
(16914),
(17007),
(17189),
(17276),
(17362),
(17381),
(17425),
(17438),
(17562),
(17563),
(17606),
(17611),
(17624),
(17760),
(17764),
(17810),
(17825),
(17912),
(17937),
(18076),
(18181),
(18361),
(18447),
(18448),
(18482),
(18536),
(18558),
(18628),
(18714),
(18736),
(18832),
(18836),
(18892),
(18966),
(19012),
(19058),
(19072),
(19174),
(19193),
(19226),
(19262),
(19295),
(19577),
(19595),
(19671),
(19675),
(19717),
(19835),
(19878),
(20067),
(20069),
(20172),
(20179),
(20181),
(20203),
(20312),
(20326),
(20364),
(20393),
(20406),
(20434),
(20520),
(20538),
(20630),
(20726),
(20830),
(20847),
(20849),
(20850),
(21109),
(21119),
(21246),
(21318),
(21391),
(21398),
(21420),
(21487),
(21516),
(21520),
(21568),
(21593),
(21663),
(21670),
(21699),
(21725),
(21731),
(21769),
(21848),
(21889),
(21918),
(21935),
(21953),
(21955),
(21962),
(21990),
(22027),
(22059),
(22125),
(22197),
(22206),
(22208),
(22211),
(22294),
(22298),
(22321),
(22341),
(22415),
(22450),
(22501),
(22520),
(22525),
(22581),
(22615),
(22621),
(22639),
(22734),
(22757),
(22810),
(22830),
(22831),
(22837),
(22887),
(22913),
(22923),
(22961),
(22985),
(23103),
(23127),
(23139),
(23146),
(23163),
(23233),
(23304),
(23324),
(23357),
(23399),
(23428),
(23459),
(23462),
(23519),
(23524),
(23533),
(23572),
(23592),
(23613),
(23664),
(23721),
(23749),
(23770),
(23807),
(23893),
(23913),
(23957),
(23990),
(24014),
(24017),
(24090),
(24123),
(24158),
(24208),
(24248),
(24251),
(24366),
(24370),
(24390),
(24519),
(24535),
(24544),
(24552),
(24555),
(24687),
(24694),
(24702),
(24710),
(24760),
(24778),
(24846),
(24914),
(24939),
(24957),
(25006),
(25023),
(25117),
(25201),
(25221),
(25261),
(25280),
(25426),
(25468),
(25470),
(25684),
(25824),
(25867),
(26159),
(26212),
(26229),
(26346),
(26353),
(26358),
(26393),
(26424),
(26486),
(26510),
(26574),
(26612),
(26645),
(26685),
(26717),
(26769),
(26788),
(26814),
(26969),
(27101),
(27104),
(27120),
(27136),
(27146),
(27183),
(27255),
(27334),
(27374),
(27456),
(27489),
(27596),
(27692),
(27813),
(27829),
(27908),
(27916),
(28100),
(28168),
(28208),
(28271),
(28374),
(28402),
(28439),
(28492),
(28547),
(28574),
(28585),
(28603),
(28881),
(29034),
(29101),
(29192),
(29233),
(29241),
(29251),
(29271),
(29342),
(29358),
(29400),
(29457),
(29551),
(29569),
(29589),
(29910),
(30008),
(30010),
(30027),
(30063),
(30109),
(30205),
(30252),
(30272),
(30376),
(30382),
(30399),
(30442),
(30512),
(30550),
(30613),
(30643),
(30684),
(30701),
(30763),
(30798),
(30981),
(31016),
(31045),
(31053),
(31200),
(31295),
(31354),
(31395),
(31649),
(31844),
(31871),
(31906),
(31943),
(32192),
(32214),
(32555),
(32581),
(32651),
(32688),
(32818),
(32849),
(32872),
(32891),
(32935),
(32977),
(32994),
(33007),
(33115),
(33117),
(33134),
(33136),
(33188),
(33241),
(33434),
(33483),
(33504),
(33511),
(33527),
(33535),
(33599),
(33650),
(33653),
(33673),
(33692),
(33716),
(33732),
(33773),
(33793),
(33810),
(33813),
(34044),
(34096),
(34112),
(34142),
(34150),
(34164),
(34171),
(34182),
(34250),
(34312),
(34323),
(34442),
(34451),
(34489),
(34546),
(34616),
(34670),
(34710),
(34731),
(34746),
(34791),
(34796),
(34816),
(34845),
(34854),
(34865),
(34870),
(34873),
(34890),
(34974),
(34979),
(34980),
(35071),
(35125),
(35127),
(35129),
(35133),
(35147),
(35161),
(35189),
(35214),
(35252),
(35333),
(35344),
(35394),
(35396),
(35421),
(35484),
(35488),
(35514),
(35534),
(35841),
(35857),
(35897),
(35962),
(35967),
(36148),
(36151),
(36157),
(36179),
(36249),
(36263),
(36345),
(36356),
(36371),
(36384),
(36485),
(36567),
(36670),
(36754),
(36785),
(36812),
(36846),
(36863),
(36871),
(36925),
(36942),
(36951),
(36988),
(37035),
(37036),
(37043),
(37075),
(37098),
(37099),
(37150),
(37354),
(37357),
(37402),
(37407),
(37456),
(37535),
(37537),
(37587),
(37593),
(37647),
(37695),
(37775),
(37805),
(37813),
(37820),
(38027),
(38046),
(38052),
(38070),
(38080),
(38103),
(38134),
(38146),
(38151),
(38170),
(38191),
(38193),
(38216),
(38217),
(38232),
(38335),
(38344),
(38373),
(38377),
(38380),
(38395),
(38401),
(38414),
(38427),
(38430),
(38434),
(38457),
(38503),
(38504),
(38594),
(38610),
(38638),
(38667),
(38671),
(38672),
(38673),
(38716),
(38764),
(38768),
(38794),
(38870),
(38885),
(38908),
(38935),
(38972),
(39028),
(39094),
(39105),
(39117),
(39152),
(39258),
(39296),
(40328),
(40381),
(40412),
(40421),
(40538),
(40554),
(40644),
(40703),
(40801),
(40802),
(40803),
(40819),
(40834),
(40922),
(41012),
(41035),
(41063),
(41086),
(41102),
(41119),
(41124),
(41134),
(41311),
(41314),
(41319),
(41391),
(41402),
(41433),
(41456),
(41489),
(41511),
(41526),
(41544),
(41575),
(41618),
(41640),
(41739),
(41757),
(41828),
(41831),
(41837),
(41838),
(41846),
(41869),
(41920),
(41925),
(41979),
(41980),
(42074),
(42095),
(42156),
(42208),
(42216),
(42273),
(42274),
(42279),
(42294),
(42297),
(42344),
(42354),
(42362),
(42402),
(42423),
(42428),
(42438),
(42442),
(42453),
(42460),
(42509),
(42519),
(42525),
(42539),
(42640),
(42642),
(42644),
(42647),
(42708),
(42763),
(42765),
(42766),
(42795),
(42802),
(42819),
(42876),
(42887),
(42953),
(43000),
(43042),
(43043),
(43048),
(43105),
(43112),
(43117),
(43126),
(43131),
(43134),
(43136),
(43143),
(43542),
(43687),
(43715),
(43867),
(43869),
(43966),
(45087),
(45107),
(45112),
(45332),
(45424),
(45488),
(45587),
(45760),
(45820),
(46214),
(48834);